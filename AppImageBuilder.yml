version: 1
script:
  # Binary is built in the workflow (cargo build --release); recipe only deploys into AppDir.
  # Script runs inside appimage-builder's container where Rust is not installed.
  - |
    set -e
    BINARY="${SOURCE_DIR:-.}/target/release/lectern"
    if [ ! -f "$BINARY" ]; then
      echo "error: release binary not found at $BINARY (build it in the workflow first)"
      exit 1
    fi
    mkdir -p $TARGET_APPDIR/usr/bin
    cp "$BINARY" $TARGET_APPDIR/usr/bin/lectern
    chmod +x $TARGET_APPDIR/usr/bin/lectern
    mkdir -p $TARGET_APPDIR/usr/share/lectern/assets
    cp -r ${SOURCE_DIR:-.}/assets/* $TARGET_APPDIR/usr/share/lectern/assets/ 2>/dev/null || true
    mkdir -p $TARGET_APPDIR/usr/share/applications
    cp ${SOURCE_DIR:-.}/lectern.desktop $TARGET_APPDIR/usr/share/applications/
    mkdir -p $TARGET_APPDIR/usr/share/icons/hicolor/256x256/apps
    cp ${SOURCE_DIR:-.}/assets/png/lectern.png $TARGET_APPDIR/usr/share/icons/hicolor/256x256/apps/lectern.png

AppDir:
  path: ./AppDir
  
  app_info:
    id: com.lectern.app
    name: Lectern
    icon: lectern
    version: "0.1.0"
    exec: usr/bin/lectern
    exec_args: $@

  apt:
    arch:
      - amd64
    sources:
      # Ubuntu 22.04 Jammy; key 871920D1991BC93C = Ubuntu Archive Automatic Signing Key
      - sourceline: deb [arch=amd64] http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
        key_url: http://keyserver.ubuntu.com/pks/lookup?op=get&search=0x871920D1991BC93C
    include:
      - ffmpeg
      - libssl3
      - ca-certificates
      - libc6
      - libgcc-s1
      - libstdc++6

  files:
    exclude:
      - usr/share/man
      - usr/share/doc/*/README.*
      - usr/share/doc/*/changelog.*
      - usr/share/doc/*/copyright
      - usr/share/doc/*/NEWS.*
      - usr/share/doc/*/AUTHORS.*
      - usr/share/doc/*/TODO.*

  test:
    fedora:
      image: fedora:latest
      command: |
        dnf install -y ffmpeg
        ./AppDir/AppRun --version || true

AppImage:
  arch: x86_64
  # update-information can be set via env UPDATE_INFO in the workflow
  # file_name defaults to: <app_info.name>-<app_info.version>-<arch>.AppImage
